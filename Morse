#include <stdio.h>
#include <string.h>
#include <tusb.h>
#include <pico/stdlib.h>
#include "usbSerialDebug/helper.h"
#include <FreeRTOS.h>
#include <task.h>
#include "tkjhat/sdk.h"

#define BUFFER_SIZE         64
#define DEFAULT_STACK_SIZE  2048
#define CDC_ITF_TX          1

// Simple LED toggle handler
static void btn_fxn(uint gpio, uint32_t eventMask) {
    uint8_t pinValue = gpio_get(LED1);
    pinValue = !pinValue;
    gpio_put(LED1, pinValue);
}

// ---------------- Morse Display + USB Output ----------------
void decode(const char *input) {
    char buf[2] = {0};

    while (*input) {
        if (*input == '.' || *input == '-' || *input == ' ') {
            clear_display();

            if (*input == ' ') {
                write_text("0");
            } else {
                buf[0] = *input;
                write_text(buf);
            }

            // --- Send Morse symbol over dual USB ---
            if (tud_cdc_n_connected(CDC_ITF_TX)) {
                tud_cdc_n_write(CDC_ITF_TX, buf, strlen(buf));
                tud_cdc_n_write_flush(CDC_ITF_TX);
            }

            if (usb_serial_connected()) {
                usb_serial_print(buf);
                usb_serial_flush();
            }

            vTaskDelay(pdMS_TO_TICKS(500));
        }
        input++;
    }

    // Newline after full message
    if (tud_cdc_n_connected(CDC_ITF_TX)) {
        tud_cdc_n_write(CDC_ITF_TX, "\n", 1);
        tud_cdc_n_write_flush(CDC_ITF_TX);
    }
    if (usb_serial_connected()) {
        usb_serial_print("\n");
        usb_serial_flush();
    }
}

static void display_task(void *arg) {
    (void)arg;

    init_display();
    printf("Initializing display\n");

    static char morse_message[] = ".- .- ... ..  --- -.   "; // "AASI ON"

    while (1) {
        decode(morse_message);
    }
}

// ---------------- TinyUSB Task ----------------
static void usbTask(void *arg) {
    (void)arg;
    while (1) {
        tud_task();  // Keep TinyUSB running
    }
}

// ---------------- Main ----------------
int main(void) {
    // stdio_init_all(); // Not used with TinyUSB dual CDC

    init_hat_sdk();
    sleep_ms(300);  // Wait for HAT and USB init

    // Initialize button + LED
    gpio_init(BUTTON1);
    gpio_set_dir(BUTTON1, GPIO_IN);
    gpio_set_irq_enabled_with_callback(BUTTON1, GPIO_IRQ_EDGE_FALL, true, btn_fxn);

    gpio_init(LED1);
    gpio_set_dir(LED1, GPIO_OUT);

    TaskHandle_t hUSB = NULL, hDisplay = NULL;

    // Create TinyUSB service task
    xTaskCreate(usbTask, "usb", 2048, NULL, 3, &hUSB);

    // Create Morse display task
    xTaskCreate(display_task, "display", 2048, NULL, 2, &hDisplay);

    // Initialize dual USB communication
    tusb_init();
    usb_serial_init();

    // Start FreeRTOS scheduler
    vTaskStartScheduler();

    // Never reached
    return 0;
}
